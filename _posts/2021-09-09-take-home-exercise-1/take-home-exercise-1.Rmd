---
title: "Take Home Exercise 1"
description: |
   To reveal the spatial temporal patterns of monthly cumulative confirmed COVID-19 rate and death rate at sub district level in Jarkata, Indonesia.
author:
  - name: Wong Wei Ling
    url: www.google.com
date: 09-09-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# 1 Overview
This analysis aims to determine the sub-district with relatively higher number of positive cases rate and death rate by using appropriate thematic mapping technique provided by tmap package. This is done by plotting maps to show the spatial temporal distribution of cumulative positive cases and death rate. 

# 2 Dataset
To perform the analysis, data sets from 2 sources are used:


1. Cumulative cases are updated daily from https://riwayat-file-covid-19-dki-jakarta-jakartagis.hub.arcgis.com/. A total of 17 .xlsx files are downloaded from March 2020 to July 2021. For files that do not contain NA values, the last day of the month's file is used i.e. 31/30, else, the next available day is used. Also, as this analysis focuses on sub-district level, the data in the "data" worksheet is used. In particular, the files that I have used are:

    + Standar Kelurahan Data Corona (24 April 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (26 Desember 2020 Pukul 10.00)
    + Standar Kelurahan Data Corona (26 Juni 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (27 Februari 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (27 Maret 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (29 Mei 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (30 April 2020 Pukul 09.00)
    + Standar Kelurahan Data Corona (30 Januari 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (30 Juni 2020 Pukul 09.00)
    + Standar Kelurahan Data Corona (30 November 2020 Pukul 10.00)
    + Standar Kelurahan Data Corona (30 September 2020 Pukul 10.00)
    + Standar Kelurahan Data Corona (31 Agustus 2020 Pukul 10.00)
    + Standar Kelurahan Data Corona (31 Juli 2020 Pukul 09.00)
    + Standar Kelurahan Data Corona (31 Juli 2021 Pukul 10.00)
    + Standar Kelurahan Data Corona (31 Maret 2020 Pukul 08.00)
    + Standar Kelurahan Data Corona (31 MEI 2020 Pukul 09.00)
    + Standar Kelurahan Data Corona (31 Oktober 2020 Pukul 10.00)


2. A collection of geospatial data in a ESRI shapefile format at different geegraphical levels is available at https://www.indonesia-geospasial.com/. Only shapefile Batas Desa Provinsi DKI Jakarta at https://www.indonesia-geospasial.com/2020/04/download-shapefile-shp-batas-desa.html will be used.

# 3 Install and Load Packages

Short explanation for the packages used: 

- readxl: to read data in .xlsx format
- tidyverse: to tidy non-spatial data
- dplyr: to transform data
- readr: to read data in .rds format
- ggplot2: to plot boxplots
- ggpubr: to arrange plots generated by ggplot2
- sf: import geospatial data 
- tmap: to plot choropleth maps

```{r echo=TRUE, eval=TRUE}
packages <- c('readxl', 'tidyr', 'dplyr', 'readr', 'ggplot2', 'ggpubr', 'sf', 'tmap')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

# 4 Data Extraction & Wrangling

## 4.1 Data Wrangling for Aspatial Data

### 4.1.1 Create function to remove duplicated rows

- Get path of aspatial data sets stored
- Read Excel file with argument .name_repair = minimal to avoid renaming of duplicated columns to e.g. "...31"
- Remove duplicated columns with argument fromLast=TRUE to extract the 2nd duplicated column, else, extract the first.
- Apply function to the data sets

```{r echo=TRUE, eval=FALSE}
filenames_list <- list.files(path= "data/aspatial", full.names=TRUE) 

clean.func <-  function(filename, filenames_list) {
  files <- read_excel(filename, .name_repair = "minimal") 
  files <- files[, !duplicated(colnames(files), fromLast=TRUE)]
}

All <- lapply(filenames_list, clean.func)

```

### 4.1.2 Add Date (consists of month and year) column for analysis in later steps

- Define values of new column for Date
- Add Date column in a list
- Extract necessary columns
- Create a DF for each list
- Bind all DFs as a single DF

```{r echo=TRUE, eval=FALSE}

new_col <-c("Apr_2021", "Dec_2020", "Jun_2021", "Feb_2021", "Mar_2021", "May_2021", "Apr_2020", "Jan_2021", "Jun_2020", 
            "Nov_2020", "Sep_2020", "Aug_2020", "Jul_2020", "Jul_2021", "Mar_2020", "May_2020", "Oct_2020")

data_list <- Map(cbind, All, Date = new_col) 

col <- c('Date', 'ID_KEL', 'Nama_provinsi','nama_kota', 'nama_kecamatan', 'nama_kelurahan', 'POSITIF', 'Meninggal')
final <- lapply(data_list,"[", col)

aspatial_final <- do.call(rbind, final)

```

### 4.1.3 Check for NA values

```{r echo=TRUE, eval=FALSE}
print(aspatial_final[rowSums(is.na(aspatial_final)) > 0,])
```

### 4.1.4 Remove rows with NA values & Ensure that it has been removed

```{r echo=TRUE, eval=FALSE}
aspatial_final <- drop_na(aspatial_final)
print(aspatial_final[rowSums(is.na(aspatial_final)) > 0,])
```


### 4.1.5 Remove rows with incorrect data 

- e.g. "LUAR DKI JAKARTA", "PROSES UPDATE DATA" & "BELUM DIKETAHUI" in columns

```{r echo=TRUE, eval=FALSE}
aspatial_final <- filter(aspatial_final, ID_KEL!="LUAR DKI JAKARTA")
aspatial_final <- filter(aspatial_final, ID_KEL!="PROSES UPDATE DATA")
aspatial_final <- filter(aspatial_final, ID_KEL!="BELUM DIKETAHUI")
```


### 4.1.6 Prepare data for calculation of cumulative positive cases & deaths

```{r echo=TRUE, eval=FALSE}
aspatial_final <- aspatial_final %>%
  group_by(Date, ID_KEL, Nama_provinsi, nama_kota, nama_kecamatan, nama_kelurahan) %>%
  summarise(`POSITIF` = sum(`POSITIF`), `Meninggal` = sum(`Meninggal`)) %>%
  ungroup() %>%
  pivot_wider(names_from = Date, values_from = c(POSITIF, Meninggal))
```


### 4.1.7 Remove rows with NA values & ensure that it has been removed 

```{r echo=TRUE, eval=FALSE}
aspatial_final <- drop_na(aspatial_final)
aspatial_final[rowSums(is.na(aspatial_final)) > 0, ]  

```

### 4.1.8 Re-order positive and deaths columns to be sequential

```{r echo=TRUE, eval=FALSE}
aspatial_final <- aspatial_final[, c(1, 2, 3, 4, 5,
                                     16, 6, 18, 14, 12, 8, 22, 21, 20, 9, 11, 10, 17, 7, 19, 15, 13, 
                                     33, 23, 35, 31, 29, 25, 39, 38, 37, 26, 28, 27, 34, 24, 36, 32, 30)]
```

### 4.1.9 Write finalised data as rds format

```{r echo=TRUE, eval=FALSE}
aspatial_final_rds <- write_rds(aspatial_final, "data/aspatial_final_rds.rds")
```

### 4.1.10 Import clean aspatial data

```{r echo=TRUE, eval=TRUE}
aspatial_final_rds <- read_rds("data/aspatial_final_rds.rds")

```



## 4.2 Data Wrangling for Geospatial Data

### 4.2.1 Import polygon feature data in shapefile format

``` {r echo=TRUE, eval=FALSE}
library(sf)
dki <- st_read(dsn = "data/geospatial", 
                layer = "BATAS_DESA_DESEMBER_2019_DUKCAPIL_DKI_JAKARTA")

```

### 4.2.2 Check CRS

```{r echo=TRUE, eval=FALSE}
st_crs(dki)

```

### 4.2.3 Convert WGS84 to national PCS of Indonesia

- DGN95 / Indonesia TM-3 zone 54.1) -> EPSG:23845 (Reference: https://epsg.io/23845)

```{r echo=TRUE, eval=FALSE}
dki <- st_transform(dki, 23845)
st_crs(dki)
```

### 4.2.4 Plot map to check for outer islands

```{r echo=TRUE, eval=FALSE}
tmap_mode('view')
tm_shape(dki) +
  tm_dots(alpha=0.4,
          col="blue",
          size=0.05)
```
- Results: After plotting, there are 6 points identified as the outer islands. When hovering over the points, the common "KAB_KOTA" is "KEPULAUAN SERIBU". These rows are to be removed in the later steps.


### 4.2.5 Switch back to plot mode after plotting interactive maps 

```{r echo=TRUE, eval=FALSE}
tmap_mode('plot')
```

### 4.2.6 Exclude outer islands, drop NA values, extract necessary fields and ensure that NA values have been dropped

```{r echo=TRUE, eval=FALSE}
dki <- dki[!dki$KAB_KOTA == "KEPULAUAN SERIBU", ] %>%
       drop_na() %>%
      select(OBJECT_ID, KODE_DESA, DESA, KODE, PROVINSI, KAB_KOTA, KECAMATAN, DESA_KELUR, JUMLAH_PEN)
print(dki[rowSums(is.na(dki)) > 0,])
```

### 4.2.7 Check features and fields of dki

```{r echo=TRUE, eval=FALSE}
print(dki)

```

### 4.2.8 Write finalised geospatial data as rds format

```{r echo=TRUE, eval=FALSE}
dki_final_rds <- write_rds(dki, "data/dki_final_rds.rds")
```

### 4.2.9 Import clean Geosptial Data

```{r echo=TRUE, eval=TRUE}
dki_final_rds <- read_rds("data/dki_final_rds.rds")

```


# 5 Data Integration & Calculations

## 5.1 Join apsatial & geospatial data

- Join by ID_KEL & KODE_DESA as values in other columns have some differences in spelling, but means the same e.g. nama_kelurahan -> KRAMAT JATI, DESA_KELUR -> KRAMATJATI

```{r echo=TRUE, eval=TRUE}
dki_aspatial <- right_join(aspatial_final_rds, dki_final_rds,
                          by = c("ID_KEL" = "KODE_DESA"))
```

## 5.2 Calculate cumulative positive cases and death rate

- The number of cumulative positive cases and death rates per 10,000 population monthly would be used for this analysis.  


### 5.2.1 Calculate total postive cases and death rates for each month

- Create derived columns for total number of positive cases and total deaths respectively. 

```{r echo=TRUE, eval=TRUE}
dki_aspatial <- dki_aspatial %>%
  mutate(`TOTAL_POSITIF` = rowSums(.[6:22])) %>%
  mutate(`TOTAL_MENINGGAL` = rowSums(.[23:39]))

```

### 5.2.2 Calculate cumulative positive cases and death rate per 10,000

- Cumulative positive cases rate per month per sub district = (Total positive cases in the month/Population)*10000
- Cumulative death rate per month per sub district = (Total deaths in the month/Population)*10000

```{r echo=TRUE, eval=TRUE}
dki_aspatial_rate <- dki_aspatial

dki_aspatial_rate[6:22] <- (dki_aspatial_rate[6:22] / dki_aspatial_rate$JUMLAH_PEN) * 10000 

dki_aspatial_rate[23:39] <- (dki_aspatial_rate[23:39] / dki_aspatial_rate$JUMLAH_PEN) * 10000


```

## 5.3 Calculate relative risk

- Relative risk would be used for this analysis as well. This is to compare number of deaths and number of expected deaths when a reference risk is being applied.

```{r echo=TRUE, eval=TRUE}
dki_aspatial_risk <- dki_aspatial %>%
  mutate(`RELATIVE_RISK` = (rowSums(.[23:39])*100) / (rowSums(.[23:39])*dki_aspatial$JUMLAH_PEN) )

```


# 6 Exploratory Data Analysis (EDA)

## 6.1 Descriptive statistics 

- Descriptive statistics for whole data set

```{r echo=TRUE, eval=TRUE}
summary(dki_aspatial_rate)
```

<br>
<br>

- Descriptive statistics for both positive rates and death rates to get the range for thematic mapping.

<left>Descriptive statistics for Mar 2020 positive cases </left> 

```{r echo=TRUE, eval=TRUE}
summary(dki_aspatial_rate$POSITIF_Mar_2020)
```

<left>Descriptive statistics for Jul 2021 positive cases </left> 

```{r echo=TRUE, eval=TRUE}
summary(dki_aspatial_rate$POSITIF_Jul_2021)
```
- From the above results, the range for cumulative positive cases rates is 0 to 3808.

<br>
<br>

<left>Descriptive statistics for Mar 2020 death rates </left> 

```{r echo=TRUE, eval=TRUE}
summary(dki_aspatial_rate$Meninggal_Mar_2020)
```

<left>Descriptive statistics for Jul 2021 death rates  </left> 

```{r echo=TRUE, eval=TRUE}
summary(dki_aspatial_rate$Meninggal_Jul_2021)
```
- From the above results, the range for cumulative death rates is 0 to 42.


## 6.2 Time-series Box Plot 

### 6.2.1  Cumulative Positive Cases

- Box plots for positive cases to check for outliers. 

```{r echo=TRUE, eval=TRUE}
boxplot_1 <- ggplot(data=dki_aspatial,
  aes(x = "", y = POSITIF_Mar_2020)) +
  geom_boxplot()

boxplot_2 <- ggplot(data=dki_aspatial,
  aes(x = "", y = POSITIF_Dec_2020)) +
  geom_boxplot()


boxplot_3 <- ggplot(data=dki_aspatial,
  aes(x = "", y = POSITIF_Jul_2021)) +
  geom_boxplot()

ggarrange(boxplot_1, boxplot_2, boxplot_3, nrow = 1)
```
- From the above box plots, positive cases rise sharply from March 2020 to July 2021 and multiple outliers can be seen. 


### 6.2.2  Cumulative Death

- Box plots for death cases to check for outliers. 

```{r echo=TRUE, eval=TRUE}
boxplot_1_m <- ggplot(data=dki_aspatial,
  aes(x = "", y = Meninggal_Mar_2020)) +
  geom_boxplot()

boxplot_2_m <- ggplot(data=dki_aspatial,
  aes(x = "", y = Meninggal_Dec_2020)) +
  geom_boxplot()

boxplot_3_m <- ggplot(data=dki_aspatial,
  aes(x = "", y = Meninggal_Jul_2021)) +
  geom_boxplot()

ggarrange(boxplot_1_m, boxplot_2_m, boxplot_3_m, nrow = 1)
```
- For the death rates in Mar 2020, it can be seen that most of the data points are all 0. Since there are only 3 data points in Mar 2020, it would be excluded for box map analysis for death rates in Mar 2020. 
- It can be observed that death rates are also on the rise from Mar 2020 to Jul 2021, but not as sharply as the positive cases. 



# 7 Thematic Mapping

Choropleth maps would be used to better understand the spatial temporal distribution of the monthly cumulative positive cases rate and cumulative death rates at sub district level. 

- Convert to sf object

```{r echo=TRUE, eval=TRUE}
dki_aspatial <- st_as_sf(dki_aspatial)
dki_aspatial_rate <- st_as_sf(dki_aspatial_rate)
dki_aspatial_risk <- st_as_sf(dki_aspatial_risk)
```

## 7.1 Choropleth Map with Custom Break

- To have a common basis of comparison of monthly cumulative positive cases rate and cumulative death rates, custom breaks with equal intervals will be used. By classifying each map with the same intervals, comparison can easily be made. 

### 7.1.1 Positive Cases Rate

- From the descriptive statistics shown in section 6.1, the positive cases rates range from 0 to 3808, from month Mar 2020 to Jul 2021.
- We can have 8 data classes, with intervals of 476.
- In the earlier months, the positive cases are generally lower and 8 data classes can be used but this might lead to over-generalising of the data, which can result in the loss of spatial patterns. 
- While it is possible to split it into more classes (such as 8 in this case), it will also be tough for the readers to differentiate the colours used in the maps.
- For the purpose of this analysis however, these custom breaks with equal intervals of 476 will be used.

#### 7.1.1.1 Function for custom break & plot choropleth map using function

```{r echo=TRUE, eval=TRUE}
custom_map_pos <- function(vnam, df, legtitle=NA){
  tm_shape(dki_aspatial_rate) +
     tm_fill(vnam,
             title=legtitle,
             n = 5,
             breaks = c(0, 476, 952, 1428, 1904, 2380, 2856, 3332, 3808),
             palette="Reds")  +
  tm_borders() +
  tm_layout(main.title = vnam,
            main.title.position = c("center","top"),
            main.title.size = 0.7,
            frame = FALSE,
            legend.show = FALSE)
}

tmap_arrange(custom_map_pos("POSITIF_Mar_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Apr_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_May_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Jun_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Jul_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Aug_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Sep_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Oct_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Nov_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Dec_2020", dki_aspatial_rate),
             custom_map_pos("POSITIF_Jan_2021", dki_aspatial_rate),
             custom_map_pos("POSITIF_Feb_2021", dki_aspatial_rate),
             custom_map_pos("POSITIF_Mar_2021", dki_aspatial_rate),
             custom_map_pos("POSITIF_Apr_2021", dki_aspatial_rate),
             custom_map_pos("POSITIF_May_2021", dki_aspatial_rate),
             custom_map_pos("POSITIF_Jun_2021", dki_aspatial_rate),
             custom_map_pos("POSITIF_Jul_2021", dki_aspatial_rate))

```

- Dark red indicates higher cumulative positive cases rate per month.
- No dark red sub-districts that can be seen from Mar 2020 to Jun 2021.
- It can subtly be observed that the cases are starting to form in the middle, then slowly spread out.
- Finally, the dark red sub-district in the middle appeared in July 2021.
- As previously mentioned, since the range for each month is so different (earlier months have much fewer cases compared to later months), using custom breaks across all months can be tough to reveal any significant spatial patterns. 


### 7.1.2 Death Rates

- Explanations for cumulative death rates are the same as above. 
- Only the custom breaks differ due to the descriptive statistics obtained from section 6.1.
- The range for death rates from Mar 2020 to Jul 2021 is 0 to 42.
- There will be 7 classes of intervals of 6.

#### 7.1.2.1 Function for custom break & plot choropleth map using function

```{r echo=TRUE, eval=TRUE}
custom_map_death <- function(vnam, df, legtitle=NA){
  tm_shape(dki_aspatial_rate) +
     tm_fill(vnam,
             title=legtitle,
             n = 5,
             breaks = c(0, 6, 12, 18, 24, 30, 36, 42),
             palette="Reds")  +
  tm_borders() +
  tm_layout(main.title = vnam,
            main.title.position = c("center","top"),
            main.title.size = 0.7,
            frame = FALSE,
            legend.show = FALSE)
}

tmap_arrange(custom_map_death("Meninggal_Mar_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Apr_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_May_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Jun_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Jul_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Aug_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Sep_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Oct_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Nov_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Dec_2020", dki_aspatial_rate),
             custom_map_death("Meninggal_Jan_2021", dki_aspatial_rate),
             custom_map_death("Meninggal_Feb_2021", dki_aspatial_rate),
             custom_map_death("Meninggal_Mar_2021", dki_aspatial_rate),
             custom_map_death("Meninggal_Apr_2021", dki_aspatial_rate),
             custom_map_death("Meninggal_May_2021", dki_aspatial_rate),
             custom_map_death("Meninggal_Jun_2021", dki_aspatial_rate),
             custom_map_death("Meninggal_Jul_2021", dki_aspatial_rate))

```

- Similar trend as above where the death rates started to form in the middle and slowly spread out to the sub-districts around it. 
- Consistent with the cumulative positive cases rate, not many significant spatial patterns can  be seen.
- Dark red sub-district only appeared in the center of the map in Jul 2021.  
- As mentioned earlier, these custom breaks may not be very useful in revealing spatial patterns in these months.  

<br>

- To deal with the challenge mentioned (custom breaks with equal intervals might lead to a loss of spatial patterns) , hence, Jenks data classification method will be used. Jenks is selected as it is a natural break classification. With that, it is able to reveal the spatial temporal patterns monthly. 


## 7.2 Choropleth Map with Jenks Data Classification

- Jenks data classification method would be used to plot choropleth maps for the cumulative positive cases rate and death rate to aid in revealing spatial patterns.

### 7.2.1 Function for Jenks Data Classification

```{r echo=TRUE, eval=TRUE}
jenksmap <- function(vnam, df, legtitle=NA){
  tm_shape(dki_aspatial_rate) +
     tm_fill(vnam,
             title=legtitle,
             n = 5,
             style = "jenks",
             palette="Reds")  +
  tm_borders() +
  tm_layout(main.title = vnam,
            main.title.position = c("center","top"),
            main.title.size = 0.7,
            frame = FALSE,
            legend.show = FALSE)
}

```


### 7.2.2 Plot choropleth maps with Jenks Data Classification (Positive Cases Rate)

```{r echo=TRUE, eval=TRUE}
tmap_arrange(jenksmap("POSITIF_Mar_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Apr_2020", dki_aspatial_rate),
             jenksmap("POSITIF_May_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Jun_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Jul_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Aug_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Sep_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Oct_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Nov_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Dec_2020", dki_aspatial_rate),
             jenksmap("POSITIF_Jan_2021", dki_aspatial_rate),
             jenksmap("POSITIF_Feb_2021", dki_aspatial_rate),
             jenksmap("POSITIF_Mar_2021", dki_aspatial_rate),
             jenksmap("POSITIF_Apr_2021", dki_aspatial_rate),
             jenksmap("POSITIF_May_2021", dki_aspatial_rate),
             jenksmap("POSITIF_Jun_2021", dki_aspatial_rate),
             jenksmap("POSITIF_Jul_2021", dki_aspatial_rate))
```
- By plotting the maps with Jenks data classification method, we can see the dark orange and dark red sub-districts slightly clearer in all the months. This means that the cumulative positive cases rate were already forming and are rising since Mar 2020. This differs from the choropleth maps plotted using custom breaks. 
- Additionally, on the bottom right of each map, we can now see that the sub-district started off with orange (Mar 2020 to Sep 2020), then dark orange (Oct 2020 to Dec 2020) then dark red (Jan 2021 to Feb 2021), then dark orange (Mar 2021 to Jul 2021). This means that the positive cases rate of the sub districts at the bottom right of the map started off with a low number, then surged as it turned to dark red, it then decreased to a low number in Jul 2021, but cumulative positive cases rate was still higher than the cases in the first few months. This observation was also unable to be seen with the custom breaks previously.     



### 7.2.3 Plot choropleth maps with Jenks Data Classification (Death Rate)

```{r echo=TRUE, eval=TRUE}
tmap_arrange(jenksmap("Meninggal_Mar_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Apr_2020", dki_aspatial_rate),
             jenksmap("Meninggal_May_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Jun_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Jul_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Aug_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Sep_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Oct_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Nov_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Dec_2020", dki_aspatial_rate),
             jenksmap("Meninggal_Jan_2021", dki_aspatial_rate),
             jenksmap("Meninggal_Feb_2021", dki_aspatial_rate),
             jenksmap("Meninggal_Mar_2021", dki_aspatial_rate),
             jenksmap("Meninggal_Apr_2021", dki_aspatial_rate),
             jenksmap("Meninggal_May_2021", dki_aspatial_rate),
             jenksmap("Meninggal_Jun_2021", dki_aspatial_rate),
             jenksmap("Meninggal_Jul_2021", dki_aspatial_rate))
```
- Similar to the explanation above, sub-districts with higher cumulative death rates can be seen slightly clearer now. 
- It can be observed that the high death rates (dark red) did not only start in Jul 2021 (as seen in custom breaks map), but started as early as Apr 2020 and it several other districts.

<br>

- Additionally, to identify outliers, box maps will be plotted as well. Box maps can reveal any outliers that might not be prominent in custom breaks and Jenks data classification choropleth maps. Hence, the section below employs box maps to reveal the patterns. 




# 8 Analytical Mapping

1. Box maps will be used to identify sub districts with outliers of cumulative positive cases rates and death rates.

    * The groups specified are: "Lower outlier", "< 25%", "25% - 50%", "50% - 75%","> 75%", "Upper outlier". Values would be considered as outliers if they are 1.5 times higher than the interquartile range. With box maps, *significant* spatial patterns are more likely to be revealed. 

2. Relative risk map will also be plotted to compare the observed mortality to the expected mortality.

## 8.1 Functions needed to plot box maps

- Get var function: to extract the variable as vector out of the dataframe.
- Box breaks function: to classify the data points by creating break points for the box map into 6 classes, namely, "Lower outlier", "1 - 25%", "25% - 50%", "50% - 75%","> 75%", "Upper outlier".
- Box map function: To plot box maps.

```{r echo=TRUE, eval=TRUE}
# Extract variable as vector out of sf dataframe
get.var <- function(vname, df) {
  v <- df[vname]
  v <- unname(v[[1]])
  return(v)
}

# To create break points for box map
boxbreaks <- function(v, mult=1.5) {
  qv <- unname(quantile(v))
  iqr <- qv[4] - qv[2]
  upfence <- qv[4] + mult * iqr
  lofence <- qv[2] - mult * iqr

  # initialize break points vector
  bb <- vector(mode="numeric",length=7)

  # logic for lower and upper fences
  if (lofence < qv[1]) { # no lower outliers
    bb[1] <- lofence
    bb[2] <- floor(qv[1])
  } else {
    bb[2] <- lofence
    bb[1] <- qv[1]
  }
  if (upfence > qv[5]) { # no upper outliers
    bb[7] <- upfence
    bb[6] <- ceiling(qv[5])
  } else {
    bb[6] <- upfence
    bb[7] <- qv[5]
  }
  bb[3:5] <- qv[2:4]
  return(bb)
}


# Boxmap function
boxmap <- function(vnam, df, mtitle, legtitle=NA, mult=1.5, palette='Reds') {
  df1 <- drop_na(df)
  var <- get.var(vnam,df1)
  bb <- boxbreaks(var)
  tm_shape(df) +
    tm_fill(vnam,
            title=legtitle,
            breaks=bb,
            palette=palette,
            labels = c("Lower outlier", "< 25%", "25% - 50%", "50% - 75%","> 75%", "Upper outlier")) +
  tm_borders(lwd=0.1, alpha=1) +
  tm_layout(main.title = vnam,
            main.title.position = 'center',
            main.title.size = 0.7,
            frame = FALSE,
            legend.show = FALSE) +
  tm_scale_bar(width = 0.15)
}

```

## 8.2 Test boxbreaks function 

```{r echo=TRUE,  eval=TRUE}
var <- get.var("Meninggal_Mar_2020", dki_aspatial_rate)
boxbreaks(var)
```

## 8.3 Time-series box map of cumulative positive cases rates

```{r echo=TRUE, eval=TRUE}
tmap_arrange(boxmap("POSITIF_Mar_2020", dki_aspatial_rate),
            boxmap("POSITIF_Apr_2020", dki_aspatial_rate),
            boxmap("POSITIF_May_2020", dki_aspatial_rate),
            boxmap("POSITIF_Jun_2020", dki_aspatial_rate),
            boxmap("POSITIF_Jul_2020", dki_aspatial_rate),
            boxmap("POSITIF_Aug_2020", dki_aspatial_rate),
            boxmap("POSITIF_Sep_2020", dki_aspatial_rate),
            boxmap("POSITIF_Oct_2020", dki_aspatial_rate),
            boxmap("POSITIF_Nov_2020", dki_aspatial_rate),
            boxmap("POSITIF_Dec_2020", dki_aspatial_rate),
            boxmap("POSITIF_Jan_2021", dki_aspatial_rate),
            boxmap("POSITIF_Feb_2021", dki_aspatial_rate),
            boxmap("POSITIF_Mar_2021", dki_aspatial_rate),
            boxmap("POSITIF_Apr_2021", dki_aspatial_rate),
            boxmap("POSITIF_May_2021", dki_aspatial_rate),
            boxmap("POSITIF_Jun_2021", dki_aspatial_rate),
            boxmap("POSITIF_Jul_2021", dki_aspatial_rate))
```
- From the above box maps, more dark red sub districts can be seen. This means that there were more sub districts that were in the upper outlier class and the severity of COVID-19 was already quite high in Mar 2020. 
- The previous choropleth maps plotted using custom breaks & jenks slightly misrepresented the situation in Jarkata as there are not many dark red sub districts shown. 
- It can also be observed that the situation of sub districts at the bottom part of the map gets increasingly serious from Mar 2020 to Jul 2021.
- Also, with respect to the bottom right sub-district, it started off being within the ">75%" class then to the "50%-75%" class then slowly increased to the upper outlier class. This observation differs slightly from the choropleth maps plotted using jenks data classification.
- With these box maps, we are able to better tell the severity of the sub-districts in Jarkata.


## 8.4 Time-series box map of cumulative death rates

- Excluded Mar 2020 column for death rates as most of the data points are 0.

```{r echo=TRUE, eval=TRUE}
tmap_arrange(boxmap("Meninggal_Apr_2020", dki_aspatial_rate),
            boxmap("Meninggal_May_2020", dki_aspatial_rate),
            boxmap("Meninggal_Jun_2020", dki_aspatial_rate),
            boxmap("Meninggal_Jul_2020", dki_aspatial_rate),
            boxmap("Meninggal_Aug_2020", dki_aspatial_rate),
            boxmap("Meninggal_Sep_2020", dki_aspatial_rate),
            boxmap("Meninggal_Oct_2020", dki_aspatial_rate),
            boxmap("Meninggal_Nov_2020", dki_aspatial_rate),
            boxmap("Meninggal_Dec_2020", dki_aspatial_rate),
            boxmap("Meninggal_Jan_2021", dki_aspatial_rate),
            boxmap("Meninggal_Feb_2021", dki_aspatial_rate),
            boxmap("Meninggal_Mar_2021", dki_aspatial_rate),
            boxmap("Meninggal_Apr_2021", dki_aspatial_rate),
            boxmap("Meninggal_May_2021", dki_aspatial_rate),
            boxmap("Meninggal_Jun_2021", dki_aspatial_rate),
            boxmap("Meninggal_Jul_2021", dki_aspatial_rate))

```

- Similar to the cumulative positive cases rate box maps, more sub-districts that fall in the upper outlier class can be seen.
- An interesting finding is that the sub-districts at the bottom gets increasingly serious whereas, the sub districts at the top gets less serious as months passed. 
- To reiterate, the custom breaks and jenks choropleth maps have slightly misrepresented the severity of the situation in Jarkata as many red sub districts can be seen in the box maps. 

